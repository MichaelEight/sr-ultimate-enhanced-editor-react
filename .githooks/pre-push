#!/bin/bash
#
# Pre-push hook to enforce branch policy
# Prevents direct pushes to 'main' branch
# Ensures development happens on 'dev' branch

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Read the branch config if it exists
CONFIG_FILE=".branchconfig.json"
PROTECTED_BRANCHES=("main" "master")
DEV_BRANCH="dev"

# Get current branch
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

# Read stdin (contains: local_ref local_sha remote_ref remote_sha)
while read local_ref local_sha remote_ref remote_sha
do
    # Extract the branch name being pushed to
    remote_branch=$(echo $remote_ref | sed -e 's,.*/\(.*\),\1,')

    # Check if pushing to a protected branch
    for protected in "${PROTECTED_BRANCHES[@]}"; do
        if [ "$remote_branch" = "$protected" ]; then
            echo -e "${RED}========================================${NC}"
            echo -e "${RED}ERROR: Direct push to '$protected' is not allowed!${NC}"
            echo -e "${RED}========================================${NC}"
            echo -e "${YELLOW}"
            echo -e "The '$protected' branch is reserved for releases only."
            echo -e ""
            echo -e "Please follow this workflow:"
            echo -e "  1. Create a feature branch from '$DEV_BRANCH':"
            echo -e "     ${GREEN}git checkout $DEV_BRANCH${YELLOW}"
            echo -e "     ${GREEN}git checkout -b feat/your-feature-name${YELLOW}"
            echo -e ""
            echo -e "  2. Make your changes and commit"
            echo -e ""
            echo -e "  3. Push your feature branch:"
            echo -e "     ${GREEN}git push -u origin feat/your-feature-name${YELLOW}"
            echo -e ""
            echo -e "  4. Create a Pull Request to merge into '$DEV_BRANCH'"
            echo -e ""
            echo -e "Valid branch prefixes: feat/, fix/, refactor/, docs/, test/, chore/, style/, perf/, ci/, build/, revert/"
            echo -e "${NC}"
            echo -e "See .branchconfig.json and CONTRIBUTING.md for more details."
            echo -e ""
            exit 1
        fi
    done

    # Validate branch naming convention (skip for claude/ branches)
    if [[ ! "$remote_branch" =~ ^claude/ ]] && [[ ! "$remote_branch" =~ ^(feat|fix|refactor|docs|test|chore|style|perf|ci|build|revert)/ ]] && [ "$remote_branch" != "$DEV_BRANCH" ]; then
        echo -e "${YELLOW}========================================${NC}"
        echo -e "${YELLOW}WARNING: Branch name doesn't follow convention${NC}"
        echo -e "${YELLOW}========================================${NC}"
        echo -e "Branch '${remote_branch}' doesn't follow the naming convention."
        echo -e ""
        echo -e "Expected format: ${GREEN}prefix/description${NC}"
        echo -e "Valid prefixes: feat/, fix/, refactor/, docs/, test/, chore/, style/, perf/, ci/, build/, revert/"
        echo -e ""
        echo -e "Examples:"
        echo -e "  - feat/user-authentication"
        echo -e "  - fix/login-bug"
        echo -e "  - refactor/database-queries"
        echo -e ""
        echo -e "Proceeding with push, but consider renaming your branch."
        echo -e ""
    fi
done

exit 0
